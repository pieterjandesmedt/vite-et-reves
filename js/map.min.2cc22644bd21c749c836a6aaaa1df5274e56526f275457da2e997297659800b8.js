mapboxgl.accessToken='pk.eyJ1IjoicGpkcyIsImEiOiJVNEdDc3RjIn0.kmBUhtCdHZI_21ySyX56CQ';var map=new mapboxgl.Map({container:'map',style:'mapbox://styles/mapbox/light-v10'});var trackPopup=new mapboxgl.Popup({closeOnClick:false});var getJSON=function(url,callback){var xhr=new XMLHttpRequest();xhr.open('GET',url,true);xhr.responseType='json';xhr.onload=function(){var status=xhr.status;if(status===200){callback(null,xhr.response);}else{callback(status,xhr.response);}};xhr.send();};map.on('load',function(){const callbacks=[];const routeData=[];routeFiles.forEach((routeFile)=>{callbacks.push('working');getJSON(`/route/${routeFile}`,function(err,data){if(err!==null){console.error('Something went wrong. We couldn\'t load route file '+routeFile+'. (Error '+err+')');}else{plotRoute(data,routeFile);routeData.push(data);console.log(routeFile+' plotted');}
callbacks.pop();if(callbacks.length===0)fitBounds(routeData);});});});function plotPosition(position){var geojson={"type":"FeatureCollection","features":[{"type":"Feature","properties":{"message":"<h6>Vite & RÃªves' current position</h6><br/><small>(Tracking data provided by <a href='https://www.logisticsplus.net' target=_blank>Logistics Plus</a>, thanks Fre and Read!)</small>","iconSize":[60,60]},"geometry":{"type":"Point","coordinates":[position.lng,position.lat]}},]};geojson.features.forEach(function(marker){var el=document.createElement('div');el.className='marker';el.style.backgroundImage='url(//images.weserv.nl/?url=https://vite-et-reves.s3.eu-west-3.amazonaws.com/vite-et-reves-sailing.jpg&w=60&h=60&fit=cover&mask=circle)';el.style.width=marker.properties.iconSize[0]+'px';el.style.height=marker.properties.iconSize[1]+'px';var popup=new mapboxgl.Popup({offset:25}).setHTML(marker.properties.message)
new mapboxgl.Marker(el).setLngLat(marker.geometry.coordinates).setPopup(popup).addTo(map);});}
function plotRoute(data,routeFile){map.addLayer({"id":routeFile,"type":"line","source":{"type":"geojson","data":data,},"layout":{"line-join":"round","line-cap":"round"},"paint":{"line-color":"#67adb7","line-width":6}});map.on('mouseenter',routeFile,function(e){var correspondingPost=posts.find(function(post){return post.gpx===e.features[0].properties.source;});if(correspondingPost){map.getCanvas().style.cursor='pointer';var coordinates=e.features[0].geometry.coordinates[Math.floor(e.features[0].geometry.coordinates.length/2)];trackPopup.setLngLat(coordinates).setHTML(correspondingPost.description).addTo(map);}});}
function fitBounds(data){console.log('fitting bounds');var coordinates=data.map(o=>o.features).reduce((p,c)=>p.concat(c),[]).map(feature=>feature.geometry.coordinates).reduce((p,c)=>p.concat(c),[]);var bounds=coordinates.reduce(function(bounds,coord){return bounds.extend(coord);},new mapboxgl.LngLatBounds(coordinates[0],coordinates[0]));map.fitBounds(bounds,{padding:100});}